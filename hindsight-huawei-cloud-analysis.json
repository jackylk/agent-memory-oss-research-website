{
  "project_name": "hindsight",
  "analysis_date": "2026-02-13",
  "version_analyzed": "v0.4.10",

  "storage": {
    "vector_storage": {
      "solution": "PostgreSQL+pgvector (集成方案)",
      "default_database": "pgvector",
      "recommended_for_huawei": "PostgreSQL+pgvector",
      "vector_dimension": 384,
      "vector_dimension_notes": "默认384维(BAAI/bge-small-en-v1.5), 可配置其他嵌入模型如OpenAI text-embedding-3-small(1536维)",
      "index_type": "HNSW或IVFFlat",
      "index_type_notes": "推荐HNSW索引(查询速度快), 数据量<100万时可用IVFFlat(构建快)",
      "supported_databases": [
        "pgvector (默认, PostgreSQL扩展)"
      ],
      "evidence": "architecture.md第348-376行确认使用pgvector扩展作为唯一向量存储方案; config.py第67行ENV_EMBEDDINGS_LOCAL_MODEL默认为BAAI/bge-small-en-v1.5(384维); architecture.md第1369-1385行描述HNSW和IVFFlat两种索引类型"
    },

    "primary_database": {
      "type": "PostgreSQL",
      "min_version": "14+",
      "recommended_version": "18 (最新稳定版)",
      "required_extensions": ["pgvector", "pg_trgm"],
      "connection_pooling": {
        "min_connections": 5,
        "max_connections": 20,
        "recommended": 50,
        "configurable": true
      },
      "ssl_support": true,
      "multi_tenant_isolation": "Schema级别隔离",
      "evidence": "docker-compose.yaml第20行使用pgvector/pgvector:pg18镜像; architecture.md第285-287行描述必需扩展pgvector和pg_trgm; architecture.md第1299-1309行描述连接池配置min_size=5, max_size=20; architecture.md第1216-1237行描述Schema级多租户隔离机制"
    },

    "graph_database": {
      "required": false,
      "recommended": false,
      "type": "内置于PostgreSQL (实体链接表)",
      "alternatives": [],
      "evidence": "architecture.md第221-234行描述entity_links和memory_links表实现图功能, 无需独立图数据库; cloud-needs.md第324行明确当前版本无对象存储依赖, 所有数据在PostgreSQL"
    },

    "cache": {
      "type": "内存缓存(应用层)",
      "required": false,
      "min_version": "N/A",
      "use_case": "实体解析缓存、会话级缓存",
      "required_modules": [],
      "alternatives": ["Redis (可选扩展)"],
      "evidence": "architecture.md第1261-1275行描述EntityResolver使用会话级内存缓存_entity_cache; architecture.md第1251-1257行明确无内存缓存, 数据库即缓存"
    },

    "history_database": {
      "type": "PostgreSQL (共用主数据库)",
      "default_path": "async_operations表",
      "production_alternative": "N/A (已集成)",
      "purpose": "记录异步操作状态、心智模型刷新任务",
      "evidence": "architecture.md第314行列出async_operations表用于异步操作跟踪"
    },

    "object_storage": {
      "required": false,
      "use_case": "备份、归档、大文件附件(未实现)",
      "supported": ["S3", "MinIO", "Azure Blob (潜在扩展)"],
      "evidence": "cloud-needs.md第132-149行明确当前版本无对象存储依赖, 所有数据存储在PostgreSQL; architecture.md第333-338行提到潜在扩展为大文件附件"
    },

    "data_scale": {
      "estimated_total": "向量数据5GB(100万记忆), 关系数据2GB, 索引数据10-15GB(HNSW)",
      "per_user_avg": "100条记忆约50MB (384维向量 + metadata + 索引)",
      "storage_breakdown": {
        "vector_data_per_memory": "约1.5KB (384维float32向量 + metadata)",
        "index_overhead": "2-3倍原始数据大小(HNSW索引)",
        "entity_nodes_per_memory": "1-3个实体",
        "memory_links_per_memory": "2-5个链接(时序/语义/实体)"
      },
      "evidence": "architecture.md第319行描述每1万条记忆约500MB(含向量); 基于384维float32向量计算384*4=1536字节; architecture.md第1369-1385行HNSW索引有2-3倍空间开销"
    }
  },

  "compute": {
    "cpu": {
      "min_vcpu": 2,
      "recommended_vcpu": 4,
      "optimal_vcpu": "8-16 (中型生产)",
      "workload_type": "IO密集型和CPU密集型混合",
      "workload_notes": "向量检索为IO密集型, 本地嵌入/重排序为CPU密集型, LLM API调用为网络IO密集型"
    },

    "memory": {
      "min_gb": 4,
      "recommended_gb": 8,
      "optimal_gb": "16-32 (中型生产)",
      "memory_intensive_ops": [
        "本地嵌入模型加载(sentence-transformers, 约2-4GB)",
        "本地重排序模型加载(cross-encoder, 约1-2GB)",
        "向量索引加载(HNSW索引常驻内存)",
        "异步任务队列缓存",
        "PostgreSQL连接池(每连接约10MB)"
      ]
    },

    "gpu": {
      "required": false,
      "use_case": "仅在使用本地嵌入或重排序模型时可选",
      "optional_scenarios": "使用外部API(OpenAI/Cohere/TEI)则无需GPU",
      "cuda_dependency": {
        "has_direct_cuda": false,
        "custom_cuda_kernels": false,
        "gpu_libraries": [
          "torch>=2.6.0 (可选, 用于本地sentence-transformers)",
          "sentence-transformers>=3.3.0 (可选)",
          "transformers>=4.53.0 (可选)"
        ],
        "evidence": "pyproject.toml第46-48行显示torch, sentence-transformers, transformers为依赖; embeddings.py第136-150行检测torch.cuda.is_available()和torch.backends.mps.is_available(); cross_encoder.py第142-160行类似GPU检测逻辑"
      },
      "gpu_models": [
        {
          "use_case": "本地嵌入生成",
          "model": "BAAI/bge-small-en-v1.5",
          "vram": "1-2GB",
          "throughput": "1000-2000 embeddings/秒"
        },
        {
          "use_case": "本地重排序",
          "model": "cross-encoder/ms-marco-MiniLM-L-6-v2",
          "vram": "1-2GB",
          "throughput": "200-500 queries/秒"
        }
      ]
    },

    "ascend_npu": {
      "compatibility_level": "容易适配",
      "overall_assessment": "Hindsight核心功能(Retain/Recall/Reflect)完全依赖LLM API调用, 不需要GPU。仅本地嵌入和重排序模型使用PyTorch, 可通过昇腾CANN适配, 但推荐使用外部API或TEI服务。",

      "framework_analysis": {
        "framework": "PyTorch",
        "framework_version": "2.6.0+",
        "framework_usage": "可选(仅本地嵌入和重排序)",
        "ascend_support": true,
        "cann_version": "CANN 8.0 RC1+",
        "pytorch_ascend_version": "torch_npu 2.1.0+",
        "evidence": "pyproject.toml第48行torch>=2.6.0为依赖; embeddings.py第136-150行和cross_encoder.py第142-160行导入torch但在设备检测中标记为可选; config.py第68行ENV_EMBEDDINGS_LOCAL_FORCE_CPU可强制CPU模式"
      },

      "reflection_gpu_analysis": {
        "operation": "Reflect (反思操作)",
        "gpu_required": false,
        "computation_type": "LLM API调用(外部服务)",
        "latency": "1-3秒 (取决于LLM提供商)",
        "local_compute": "无(仅网络IO和JSON解析)",
        "evidence": "reflect/agent.py第1-100行显示Reflect操作通过LLMProvider调用外部LLM API(OpenAI/Anthropic/Gemini等), 不涉及本地模型推理; architecture.md第1479行明确Reflect操作延迟1-3秒主要来自LLM调用"
      },

      "migration": {
        "effort_level": "低",
        "migration_path": "无需迁移(使用API) 或 简单适配(自托管)",
        "blockers": [],
        "code_changes_required": [
          "若本地嵌入: 安装torch-npu, 设置HINDSIGHT_API_EMBEDDINGS_LOCAL_FORCE_CPU=false",
          "若本地重排序: 修改cross_encoder.py第154行torch.cuda.is_available()为torch.npu.is_available()",
          "或使用外部TEI服务: 设置HINDSIGHT_API_EMBEDDINGS_PROVIDER=tei, HINDSIGHT_API_RERANKER_PROVIDER=tei",
          "推荐: 使用华为云ModelArts托管嵌入服务替代本地模型"
        ],
        "testing_required": [
          "验证PyTorch NPU算子兼容性(sentence-transformers常用算子)",
          "精度验证(embedding向量与CPU/GPU一致性)",
          "性能基准测试(NPU vs CPU embedding速度)"
        ]
      },

      "deployment_scenarios": [
        {
          "scenario": "推荐方案1: 使用外部LLM和嵌入API",
          "description": "使用OpenAI/Anthropic API提供LLM服务, 使用OpenAI/Cohere提供嵌入服务",
          "npu_required": false,
          "difficulty": "无",
          "cost": "按API调用付费(约¥40/月中等规模)",
          "华为云支持": "支持通过公网调用外部API"
        },
        {
          "scenario": "推荐方案2: 华为云ModelArts托管嵌入",
          "description": "使用华为云ModelArts托管嵌入模型, LLM仍使用外部API",
          "npu_required": false,
          "difficulty": "低(需开发TEI兼容接口)",
          "cost": "固定实例费用 + API调用",
          "华为云支持": "原生支持, 基于昇腾NPU"
        },
        {
          "scenario": "方案3: 自托管在昇腾NPU",
          "description": "在华为云ECS昇腾NPU实例上自托管嵌入和重排序模型",
          "npu_required": true,
          "difficulty": "中(需修改设备检测代码)",
          "cost": "固定实例费用(¥1000-2000/月)",
          "华为云支持": "支持, 提供昇腾310/910B NPU实例"
        },
        {
          "scenario": "方案4: TEI推理引擎(推荐生产)",
          "description": "使用HuggingFace Text Embeddings Inference(TEI)部署嵌入服务",
          "npu_required": false,
          "difficulty": "低",
          "cost": "固定实例费用(CPU/GPU均可)",
          "华为云支持": "支持, 可部署在ECS或CCE"
        }
      ],

      "recommendation": "对于Hindsight项目, 推荐使用外部LLM API(OpenAI/Anthropic) + TEI嵌入服务, 无需昇腾NPU。Reflect操作完全依赖LLM API, 不涉及本地GPU计算。仅当月嵌入调用超过500万次且需要私有化部署时, 再考虑昇腾NPU自托管方案。代码适配工作量极小(预计0.5-1天), 主要是设备检测逻辑修改。"
    },

    "serverless": {
      "suitable": false,
      "reasons": [
        "需要持久化向量索引(HNSW索引加载时间>3秒, 不适合Lambda冷启动)",
        "PostgreSQL连接池需要保持活跃连接",
        "向量检索性能依赖索引常驻内存",
        "本地嵌入模型加载时间>5秒(若使用)"
      ],
      "partial_serverless": {
        "feasible": true,
        "approach": "API层使用云容器实例(CCI), 数据层使用托管RDS PostgreSQL, 嵌入使用外部API或TEI",
        "limitations": "仍需最小1个常驻实例保持向量索引热度"
      }
    }
  },

  "external_services": {
    "llm": {
      "providers": [
        "OpenAI (推荐: o3-mini, gpt-4)",
        "Anthropic Claude (推荐: claude-sonnet-4-20250514)",
        "Google Gemini (gemini-2.0-flash)",
        "Groq (高速推理)",
        "Ollama (本地部署)",
        "LM Studio (本地推理服务器)",
        "Vertex AI"
      ],
      "default_model": "依环境变量配置, 无硬编码默认",
      "cost_per_million_tokens": "约$0.50-3.00",
      "monthly_cost_estimate": "¥40-100 (中等规模: 1万次Retain + 1万次Reflect)",
      "evidence": "architecture.md第380-406行列出支持的LLM提供商; config.py第24-33行定义LLM环境变量; architecture.md第409-428行提供Token消耗估算"
    },

    "embedding_models": {
      "providers": [
        "本地 sentence-transformers (默认: BAAI/bge-small-en-v1.5)",
        "TEI (HuggingFace Text Embeddings Inference)",
        "OpenAI (text-embedding-3-small)",
        "Cohere (embed-english-v3.0)",
        "LiteLLM (多提供商代理)"
      ],
      "default_model": "BAAI/bge-small-en-v1.5 (本地)",
      "default_dimensions": 384,
      "cost_per_million_tokens": "$0 (本地) 或 $0.02 (OpenAI)",
      "monthly_cost_estimate": "¥0 (本地) 或 ¥100-200 (OpenAI API, 100万记忆/月)",
      "evidence": "architecture.md第365-375行描述默认使用BAAI/bge-small-en-v1.5(384维); config.py第66-72行定义嵌入模型环境变量; embeddings.py第93-106行LocalSTEmbeddings默认模型"
    },

    "reranker": {
      "providers": [
        "本地 sentence-transformers cross-encoder (默认: cross-encoder/ms-marco-MiniLM-L-6-v2)",
        "TEI (HuggingFace)",
        "Cohere Reranker",
        "LiteLLM",
        "FlashRank (轻量级, 无PyTorch依赖)"
      ],
      "required": true,
      "use_case": "四路检索结果融合后重排序(关键组件)",
      "evidence": "architecture.md第155-161行描述使用cross-encoder重排序; config.py第97-99行定义重排序环境变量; cross_encoder.py第83-116行LocalSTCrossEncoder实现"
    }
  },

  "huawei_cloud": {
    "overall_difficulty": "低",
    "difficulty_notes": "主要优势是无需独立图数据库(Neo4j), 所有数据统一在PostgreSQL中。华为云RDS PostgreSQL原生支持pgvector扩展, 部署难度低于mem0。",

    "recommended_services": {
      "vector_solution": {
        "option1": "RDS PostgreSQL + pgvector扩展(唯一方案)",
        "option1_version": "PostgreSQL 14, 15或18",
        "option1_instance": "RDS for PostgreSQL 高可用版",
        "option1_spec": "通用型 | 4核16GB起步",
        "option1_storage": "云盘SSD 200GB起",
        "recommendation": "pgvector是Hindsight唯一支持的向量存储方案, 推荐RDS托管服务"
      },

      "database": {
        "service": "RDS for PostgreSQL",
        "version": "PostgreSQL 14.8, 15.3或18.x (推荐18)",
        "instance_type": "高可用版(主备)",
        "spec": "通用型 | 2核8GB(小规模) 到 8核32GB(中规模)",
        "storage": "云盘SSD 100-500GB",
        "extensions": ["pgvector (华为云RDS已原生支持)", "pg_trgm (模糊匹配)"]
      },

      "graph_database": {
        "service": "不需要 (已内置在PostgreSQL)",
        "instance_type": "N/A",
        "spec": "N/A",
        "storage": "N/A",
        "high_availability": "由RDS PostgreSQL高可用版提供",
        "alternative": "无需替代方案"
      },

      "cache": {
        "service": "可选 - DCS for Redis",
        "version": "Redis 6.0或7.0",
        "instance_type": "主备版",
        "spec": "2GB-8GB内存",
        "use_case": "可选(用于扩展LLM响应缓存或实体缓存)"
      },

      "compute": {
        "service": "CCE (云容器引擎) 或 ECS",
        "recommended": "CCE Kubernetes集群",
        "node_spec": "通用计算增强型 s7.xlarge.4 (4核16GB) × 2-3节点",
        "auto_scaling": "支持HPA(水平扩缩容)",
        "alternative": "ECS单机部署(小规模)"
      },

      "ai_acceleration": {
        "scenario": "仅当自托管本地嵌入/重排序时需要",
        "option1": "不使用加速(使用外部API或TEI, 强烈推荐)",
        "option2": "ModelArts在线服务(华为云托管推理, 推荐)",
        "option3": "ECS CPU实例 (c7.xlarge.4, 纯CPU推理)",
        "option4": "ECS昇腾NPU实例 (ai1s.xlarge.4, 1×昇腾310 NPU)",
        "option5": "ECS GPU实例 (pi2.xlarge.4, 1×V100 16GB)",
        "recommendation": "强烈推荐option1(外部API)或option2(ModelArts), 性价比最高且无需适配"
      },

      "load_balancer": {
        "service": "ELB (弹性负载均衡)",
        "type": "应用型负载均衡(HTTP/HTTPS)",
        "bandwidth": "5Mbps起(按需扩容)"
      },

      "monitoring": {
        "service": "云监控CES + 应用性能管理APM",
        "metrics": "CPU、内存、网络、PostgreSQL连接数、向量检索延迟",
        "alerting": "支持短信/邮件/企业微信告警",
        "opentelemetry": "Hindsight原生支持OpenTelemetry追踪"
      },

      "object_storage": {
        "service": "OBS (对象存储服务)",
        "use_case": "数据库备份、日志归档(可选)",
        "storage_class": "标准存储(热数据) / 低频访问(冷数据)"
      }
    },

    "cost_estimation": {
      "small_scale": {
        "description": "100用户, 10,000条记忆, 50 QPS",
        "monthly_cost": "¥1,500-2,000",
        "breakdown": {
          "RDS PostgreSQL": "¥800 (2核8GB 高可用版 + 100GB存储)",
          "CCE节点": "¥600 (s7.large.4 2核8GB × 2节点)",
          "ELB": "¥100 (5Mbps带宽)",
          "OpenAI API": "¥200 (LLM+嵌入, 约5000次Retain + 1000次Reflect)",
          "监控和其他": "¥100"
        },
        "notes": "假设使用外部OpenAI API, 不自托管嵌入。相比mem0节省约¥1000-1500/月(无需Neo4j)"
      },

      "medium_scale": {
        "description": "1000用户, 100,000条记忆, 300 QPS",
        "monthly_cost": "¥4,000-5,500",
        "breakdown": {
          "RDS PostgreSQL": "¥2,000 (4核16GB 高可用版 + 300GB存储)",
          "CCE节点": "¥1,800 (s7.xlarge.4 4核16GB × 3节点)",
          "ELB": "¥200 (10Mbps带宽)",
          "DCS Redis": "¥300 (主备版 4GB, 可选)",
          "OpenAI API": "¥1,000 (LLM+嵌入, 约5万次Retain + 1万次Reflect)",
          "监控和其他": "¥200"
        },
        "notes": "相比mem0节省约¥1500-2500/月(无需Neo4j)"
      },

      "large_scale": {
        "description": "10,000用户, 1,000,000条记忆, 1500 QPS",
        "monthly_cost": "¥12,000-16,000",
        "breakdown": {
          "RDS PostgreSQL": "¥5,000 (8核32GB 高可用版 + 1TB存储)",
          "CCE节点": "¥5,400 (s7.2xlarge.4 8核32GB × 4节点)",
          "ELB": "¥500 (50Mbps带宽)",
          "DCS Redis": "¥600 (主备版 8GB)",
          "自托管Embedding on CPU": "¥600 (c7.2xlarge.4 CPU实例)",
          "OBS备份": "¥100 (500GB存储)",
          "监控和其他": "¥500"
        },
        "notes": "此规模建议自托管embedding降低API成本。相比mem0节省约¥6000-9000/月(无需Neo4j集群)"
      },

      "cost_optimization_tips": [
        "使用包年包月享85折优惠",
        "非高峰时段可缩容CCE节点数量",
        "冷数据归档到OBS低频存储",
        "向量数据使用Scalar Quantization节省50%存储",
        "嵌入调用超过500万次/月时切换为自托管或TEI",
        "Reflect操作使用更快更便宜的LLM(如o3-mini替代gpt-4)",
        "配置合理的HNSW索引参数(m=16, ef_construction=64)平衡性能和存储"
      ]
    },

    "special_requirements": [
      "pgvector扩展需要PostgreSQL 14+, 华为云RDS已原生支持",
      "HNSW索引参数需调优: m=16, ef_construction=64 (默认推荐)",
      "向量索引需要足够内存, RDS内存配置建议为数据量的2-3倍",
      "多租户部署需配置PostgreSQL Schema隔离(已内置支持)",
      "若使用昇腾NPU, 需确认PyTorch版本兼容性(torch-npu 2.1.0+)",
      "LLM API调用需配置合理的并发控制(默认max_concurrent=10)"
    ],

    "architecture_recommendations": [
      {
        "scale": "小规模(< 1万记忆)",
        "architecture": "单可用区 | RDS+CCE",
        "diagram": "ELB → CCE(Hindsight API × 2) → RDS PostgreSQL",
        "cost": "¥1,500-2,000/月",
        "sla": "99.9%",
        "notes": "架构简洁, 无需独立图数据库"
      },
      {
        "scale": "中规模(1-10万记忆)",
        "architecture": "多可用区 | RDS主备+CCE集群",
        "diagram": "ELB → CCE(Hindsight API × 3-4) → RDS HA + DCS Redis",
        "cost": "¥4,000-5,500/月",
        "sla": "99.95%"
      },
      {
        "scale": "大规模(10万+记忆)",
        "architecture": "多可用区 | RDS读写分离+CCE自动扩缩容",
        "diagram": "ELB → CCE(Auto-scaling) → RDS主备+只读副本 + DCS Redis + 自托管TEI",
        "cost": "¥12,000-16,000/月",
        "sla": "99.99%",
        "notes": "此规模建议使用TEI自托管嵌入服务"
      }
    ],

    "deployment_steps": [
      {
        "step": 1,
        "title": "准备基础设施",
        "tasks": [
          "创建VPC和子网(至少2个可用区)",
          "配置安全组(开放80/443/5432端口)",
          "创建RDS PostgreSQL实例(14.8, 15.3或18.x, 推荐18)",
          "启用pgvector和pg_trgm扩展(RDS控制台一键启用)"
        ]
      },
      {
        "step": 2,
        "title": "初始化数据库",
        "tasks": [
          "连接到RDS实例",
          "运行CREATE EXTENSION vector; CREATE EXTENSION pg_trgm;",
          "验证扩展已安装: SELECT * FROM pg_extension;",
          "配置连接池参数(max_connections=100)"
        ]
      },
      {
        "step": 3,
        "title": "部署Hindsight应用",
        "tasks": [
          "创建CCE Kubernetes集群(2-3节点起)",
          "构建Hindsight Docker镜像(基于官方镜像ghcr.io/vectorize-io/hindsight:latest)",
          "创建ConfigMap(配置数据库连接: HINDSIGHT_API_DATABASE_URL)",
          "创建Secret(存储LLM API Key: HINDSIGHT_API_LLM_API_KEY)",
          "部署Deployment和Service资源",
          "配置HPA(水平Pod自动扩缩容, 目标CPU 70%)"
        ]
      },
      {
        "step": 4,
        "title": "配置负载均衡和域名",
        "tasks": [
          "创建ELB应用型负载均衡器",
          "绑定CCE Service(API端口8888, 管理界面9999)",
          "配置健康检查(HTTP GET /health)",
          "申请SSL证书(可选)",
          "配置HTTPS监听器",
          "绑定域名(可选)"
        ]
      },
      {
        "step": 5,
        "title": "监控和告警",
        "tasks": [
          "启用云监控CES",
          "配置自定义指标(QPS、Retain/Recall/Reflect延迟、错误率)",
          "设置告警规则(CPU>80%, 内存>85%, PostgreSQL连接数>80%, 错误率>5%)",
          "集成APM应用性能管理(可选)",
          "配置OpenTelemetry导出到华为云APM或自建Prometheus",
          "配置日志采集到LTS日志服务"
        ]
      },
      {
        "step": 6,
        "title": "测试和优化",
        "tasks": [
          "功能测试(Retain/Recall/Reflect三大操作)",
          "性能测试(压测100-1000 QPS)",
          "调优数据库连接池(asyncpg max_size=20-50)",
          "调优HNSW索引参数(CREATE INDEX USING hnsw ... WITH (m=16, ef_construction=64))",
          "调优LLM并发控制(HINDSIGHT_API_LLM_MAX_CONCURRENT=10)",
          "验证备份恢复流程"
        ]
      }
    ],

    "migration_from_other_clouds": {
      "from_aws": {
        "mapping": {
          "RDS PostgreSQL": "直接迁移(使用DRS数据复制服务)",
          "ECS/EKS": "重新部署到CCE",
          "Aurora PostgreSQL": "导出数据重新导入RDS PostgreSQL"
        },
        "challenges": [
          "pgvector索引需重建(HNSW索引格式兼容但需重新创建)",
          "LLM API调用配置需更新(环境变量)"
        ]
      },
      "from_gcp": {
        "mapping": {
          "Cloud SQL PostgreSQL": "使用DRS迁移到RDS",
          "GKE": "重新部署到CCE"
        }
      }
    },

    "华为云特有优势": [
      "无需独立图数据库, 架构简洁运维成本低(相比mem0节省约30-40%成本)",
      "RDS PostgreSQL原生支持pgvector扩展, 无需手动安装",
      "国内网络延迟低(相比海外云服务)",
      "数据主权和合规性(满足网络安全法)",
      "技术支持响应快(中文服务)",
      "与华为云ModelArts深度集成(可托管嵌入模型)",
      "昇腾NPU可选(若需自托管大模型, 但不推荐)"
    ],

    "华为云局限性": [
      "部分AI服务(如embedding API)不如OpenAI丰富, 需外部API或自托管",
      "海外区域覆盖不如AWS/GCP",
      "开源社区生态相比国际云厂商较弱",
      "PostgreSQL 18版本可能需要等待华为云RDS更新(当前主要支持14.8和15.3)"
    ]
  },

  "technical_details": {
    "programming_language": "Python 3.11+",
    "web_framework": "FastAPI (异步)",
    "orm": "SQLAlchemy 2.0+ (用于迁移), asyncpg (用于查询)",
    "async_support": true,
    "containerized": true,
    "container_base_image": "Python 3.11-slim (多阶段构建)",
    "package_manager": "Hatchling (pyproject.toml)",

    "dependencies_summary": {
      "core_required": [
        "asyncpg>=0.29.0",
        "fastapi[standard]>=0.120.3",
        "pydantic>=2.0.0",
        "pgvector>=0.4.1",
        "sqlalchemy>=2.0.44",
        "openai>=1.0.0 (或其他LLM提供商)"
      ],
      "optional_local_ml": [
        "sentence-transformers>=3.3.0",
        "transformers>=4.53.0",
        "torch>=2.6.0",
        "flashrank>=0.2.0"
      ],
      "optional_llms": "7+ providers (OpenAI, Anthropic, Gemini, Groq, Ollama, LM Studio, Vertex AI)",
      "optional_embedders": "5+ providers (本地, TEI, OpenAI, Cohere, LiteLLM)"
    },

    "performance_characteristics": {
      "retain_latency_p95": "2-5秒 (取决于LLM API响应时间)",
      "recall_latency_p95": "< 200ms (四路并行检索+重排序)",
      "reflect_latency_p95": "1-3秒 (取决于LLM API响应时间)",
      "throughput_per_instance": "50-150 QPS (4核8GB, 主要受LLM API限流影响)",
      "vector_index_load_time": "3-8秒 (10万向量HNSW索引)",
      "connection_pool_overhead": "每个asyncpg连接约5MB内存"
    },

    "security_features": [
      "JWT认证(可选, 通过环境变量启用)",
      "API Key认证(可选)",
      "无认证模式(默认, 适合内网或反向代理已处理认证)",
      "SSL/TLS支持(通过反向代理如Nginx)",
      "多租户PostgreSQL Schema隔离(防止跨租户数据泄露)",
      "SQL注入防护(全部使用asyncpg参数化查询)",
      "敏感数据脱敏(日志中mask API Key和数据库密码)"
    ]
  },

  "deployment_complexity_assessment": {
    "overall_score": "4/10",
    "factors": {
      "service_count": "低(2-3个核心服务: RDS+CCE+ELB)",
      "state_management": "中(单一PostgreSQL数据库)",
      "data_consistency": "低(无需同步多个数据库)",
      "monitoring": "低(仅需监控RDS和应用)",
      "scaling": "低(大部分组件支持水平扩展)"
    },
    "complexity_drivers": [
      "向量索引需要细致调优(HNSW参数m, ef_construction)",
      "LLM API调用需要处理限流和重试(已内置)",
      "多租户Schema隔离需要正确配置(已内置)"
    ],
    "simplicity_advantages": [
      "无需独立图数据库(相比mem0减少1-3个服务)",
      "无需Redis缓存(可选)",
      "单一数据库简化备份和恢复",
      "Docker镜像预加载ML模型, 开箱即用"
    ]
  },

  "recommendations": {
    "quick_start": {
      "phase": "原型验证(1天)",
      "approach": "本地Docker单机部署 + OpenAI API",
      "cost": "¥50-200 (仅API调用)"
    },
    "production_ready": {
      "phase": "生产部署(2-3周)",
      "approach": "华为云CCE + RDS PostgreSQL + OpenAI API",
      "cost": "¥1,500-5,500/月 (根据规模)"
    },
    "enterprise_scale": {
      "phase": "企业级(1-2月)",
      "approach": "多可用区HA + 读写分离 + 自托管TEI嵌入",
      "cost": "¥12,000-16,000/月"
    },

    "best_practices": [
      "优先使用托管RDS降低运维成本",
      "RDS定期备份到OBS(每日增量+每周全量)",
      "向量数据使用Scalar Quantization压缩节省50%存储和内存",
      "配置合理的连接池大小(asyncpg max_size=20-50)",
      "使用CDN加速管理界面静态资源(端口9999)",
      "监控LLM API调用量和成本(设置预算告警)",
      "配置OpenTelemetry导出到APM或Prometheus",
      "使用蓝绿部署或金丝雀发布降低上线风险",
      "HNSW索引参数调优: m=16(适合384维), ef_construction=64(平衡构建速度和质量)",
      "Reflect操作使用更快更便宜的LLM(o3-mini > gpt-4.1-nano > claude-sonnet)"
    ],

    "cost_optimization_strategies": [
      "使用包年包月享85折优惠",
      "非高峰时段缩减CCE节点(通过CronHPA)",
      "冷数据归档到OBS低频存储类",
      "嵌入调用量大时切换为自托管TEI(盈亏平衡点约500万次/月)",
      "使用华为云预留实例(RI)进一步降低30%成本",
      "向量数据Scalar Quantization减少50%内存占用",
      "使用更小的嵌入模型(如BAAI/bge-base-en-v1.5的768维版本)节省存储",
      "Retain操作使用更便宜的LLM(如o3-mini替代gpt-4)",
      "配置合理的LLM并发控制避免超额调用(max_concurrent=10)",
      "使用华为云ModelArts托管嵌入服务(按调用付费, 低频场景更划算)"
    ]
  },

  "risks_and_mitigations": {
    "technical_risks": [
      {
        "risk": "RDS PostgreSQL单点故障",
        "impact": "高(整个系统不可用)",
        "mitigation": "使用RDS高可用版(主备自动切换) + 定期备份到OBS",
        "probability": "极低(RDS HA版SLA 99.95%)"
      },
      {
        "risk": "向量索引损坏",
        "impact": "高(检索性能下降或失败)",
        "mitigation": "定期备份向量数据 + 配置索引自动重建脚本",
        "probability": "极低"
      },
      {
        "risk": "LLM API限流或故障",
        "impact": "高(Retain和Reflect操作失败)",
        "mitigation": "配置多LLM提供商failover(如OpenAI主, Anthropic备) + 指数退避重试(已内置)",
        "probability": "中"
      },
      {
        "risk": "内存泄漏(Python应用)",
        "impact": "中(需定期重启Pod)",
        "mitigation": "配置Pod内存限制 + 定期重启策略(如每24小时) + 内存监控告警",
        "probability": "低"
      },
      {
        "risk": "PostgreSQL连接数耗尽",
        "impact": "中(新请求无法连接数据库)",
        "mitigation": "配置合理的连接池上限(max_size=20-50) + 监控连接数告警",
        "probability": "低"
      }
    ],
    "business_risks": [
      {
        "risk": "成本超预算(LLM API调用)",
        "impact": "中",
        "mitigation": "设置OpenAI/Anthropic账单告警 + 监控Retain/Reflect调用量 + 优化API调用频率",
        "probability": "中"
      },
      {
        "risk": "数据合规问题",
        "impact": "高(若涉及个人隐私数据)",
        "mitigation": "数据加密存储(RDS支持TDE) + 定期安全审计 + 实现GDPR数据删除接口 + 使用自托管LLM(Ollama)避免数据泄露",
        "probability": "低"
      }
    ]
  },

  "comparison_with_mem0": {
    "architecture_differences": [
      "Hindsight无需独立图数据库(Neo4j), 所有数据在PostgreSQL",
      "Hindsight使用entity_links和memory_links表实现图功能",
      "Hindsight默认向量维度384(更小, 更快), mem0默认1536",
      "Hindsight支持Schema级多租户隔离, mem0使用user_id/agent_id过滤"
    ],
    "cost_advantages": [
      "小规模节省约¥1000-1500/月(无需Neo4j)",
      "中规模节省约¥1500-2500/月(无需Neo4j集群)",
      "大规模节省约¥6000-9000/月(无需Neo4j集群+简化运维)",
      "向量存储成本更低(384维 vs 1536维, 节省75%存储)"
    ],
    "deployment_simplicity": [
      "Hindsight服务数量更少(2-3个 vs mem0的4-6个)",
      "Hindsight备份更简单(仅需备份PostgreSQL)",
      "Hindsight运维复杂度更低(无需管理Neo4j)",
      "Hindsight Docker镜像开箱即用(预加载ML模型)"
    ],
    "功能差异": [
      "Hindsight有Reflect操作(深度反思), mem0无此功能",
      "Hindsight支持时序记忆和时间旅行查询",
      "Hindsight支持心智模型(Mental Models)和指令(Directives)",
      "mem0图谱功能更强(Neo4j原生), Hindsight图功能基于SQL"
    ]
  },

  "next_steps": [
    "1. 申请华为云账号并完成实名认证",
    "2. 在华为云控制台创建VPC和子网规划",
    "3. 部署RDS PostgreSQL实例(推荐18.x版本)并启用pgvector扩展",
    "4. 本地测试Docker镜像: docker run -p 8888:8888 -e HINDSIGHT_API_LLM_API_KEY=$OPENAI_API_KEY ghcr.io/vectorize-io/hindsight:latest",
    "5. 创建CCE集群并部署Hindsight应用",
    "6. 配置ELB和域名",
    "7. 执行功能测试(Retain/Recall/Reflect三大操作)",
    "8. 执行性能测试(压测100-1000 QPS)",
    "9. 配置监控告警(云监控CES + OpenTelemetry)",
    "10. 编写运维文档和应急预案"
  ],

  "references": {
    "code_analysis": [
      "pyproject.toml - 依赖关系和版本要求",
      "docker/docker-compose/docker-compose.yaml - 默认部署架构",
      "hindsight-api/hindsight_api/config.py - 配置和环境变量",
      "hindsight-api/hindsight_api/engine/embeddings.py - 嵌入模型实现和GPU检测",
      "hindsight-api/hindsight_api/engine/cross_encoder.py - 重排序模型实现和GPU检测",
      "hindsight-api/hindsight_api/engine/reflect/agent.py - Reflect操作实现(仅LLM API调用)"
    ],
    "documentation": [
      "architecture.md - 架构设计文档",
      "cloud-needs.md - 云服务需求分析",
      "README.md - 项目简介",
      "CLAUDE.md - 开发指南"
    ],
    "external": [
      "华为云RDS for PostgreSQL文档",
      "华为云CCE Kubernetes文档",
      "pgvector官方文档",
      "昇腾CANN开发文档",
      "HuggingFace Text Embeddings Inference文档"
    ]
  }
}
